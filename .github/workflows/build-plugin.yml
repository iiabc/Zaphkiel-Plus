name: Build and Publish Plugin

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4

      - name: Set up JDK 8
        uses: actions/setup-java@v4
        with:
          java-version: '8'
          distribution: 'temurin'

      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches    
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}
          restore-keys: |
            ${{ runner.os }}-gradle-    

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean and build with Gradle
        run: ./gradlew clean build

      - name: Extract version from gradle.properties
        id: extract_version
        run: |
          VERSION=$(grep "version=" gradle.properties | cut -d'=' -f2)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "📦 Version: $VERSION"

      - name: Verify built JAR
        run: |
          cd plugin/build/libs
          echo "📦 构建产物:"
          ls -lh
          if [ ! -f "Zaphkiel-${{ steps.extract_version.outputs.version }}.jar" ]; then
            echo "❌ 未找到预期的 JAR 文件"
            exit 1
          fi
          echo "✅ JAR 文件已生成: Zaphkiel-${{ steps.extract_version.outputs.version }}.jar"

      - name: Upload plugin JAR
        uses: actions/upload-artifact@v4
        with:
          name: Zaphkiel-plugin-${{ github.run_number }}
          path: plugin/build/libs/Zaphkiel-*.jar

      # 🎯 自动发布到 Pakko
      - name: Publish to Pakko
        env:
          PAKKO_API_URL: ${{ secrets.PAKKO_API_URL }}
          PAKKO_API_KEY: ${{ secrets.PAKKO_API_KEY }}
          VERSION: ${{ steps.extract_version.outputs.version }}
        run: |
          # 查找构建的 JAR 文件
          JAR_FILE="plugin/build/libs/Zaphkiel-$VERSION.jar"
          CHANGELOG_FILE="version/$VERSION.md"
          
          # 验证 JAR 文件是否存在（必须）
          if [ ! -f "$JAR_FILE" ]; then
            echo "❌ 未找到 JAR 文件: $JAR_FILE"
            exit 1
          fi
          
          echo "📦 找到 JAR 文件: $JAR_FILE"
          JAR_SIZE=$(du -h "$JAR_FILE" | cut -f1)
          echo "📊 JAR 文件大小: $JAR_SIZE"
          
          # 检查版本日志文件是否存在（可选）
          if [ -f "$CHANGELOG_FILE" ]; then
            echo "📝 找到版本日志文件: $CHANGELOG_FILE"
            CHANGELOG_SIZE=$(du -h "$CHANGELOG_FILE" | cut -f1)
            echo "📊 日志文件大小: $CHANGELOG_SIZE"
            HAS_CHANGELOG=true
          else
            echo "⚠️  未找到版本日志文件: $CHANGELOG_FILE（将只上传 JAR 文件）"
            HAS_CHANGELOG=false
          fi
          
          # 构建 curl 命令
          echo "📤 上传到 Pakko (版本: $VERSION)..."
          
          # 基础 curl 命令
          CURL_CMD="curl -X POST \"$PAKKO_API_URL/api/resources\" \
            -H \"x-api-key: $PAKKO_API_KEY\" \
            -F \"name=zaphkiel-plus\" \
            -F \"slug=zaphkiel-plus\" \
            -F \"version=$VERSION\" \
            -F \"description=自定义物品系统框架\" \
            -F \"docUrl=https://iplugin.hiusers.com/docs/zaphkiel-plus\" \
            -F \"afdianType=free\" \
            -F \"files=@$JAR_FILE\""
          
          # 如果存在版本日志文件，添加到上传列表
          if [ "$HAS_CHANGELOG" = true ]; then
            CURL_CMD="$CURL_CMD -F \"files=@$CHANGELOG_FILE\""
          fi
          
          # 执行上传并捕获响应和 HTTP 状态码
          # 使用 -w 选项获取 HTTP 状态码，-o 保存响应体
          RESPONSE_FILE=$(mktemp)
          HTTP_CODE=$(eval $CURL_CMD -w "%{http_code}" -o "$RESPONSE_FILE" -s)
          RESPONSE=$(cat "$RESPONSE_FILE" 2>/dev/null || echo "")
          rm -f "$RESPONSE_FILE"
          
          echo "📝 API 响应:"
          echo "$RESPONSE"
          echo "📊 HTTP 状态码: $HTTP_CODE"
          
          # 检查是否成功（HTTP 状态码 200-299 表示成功）
          if [ -n "$HTTP_CODE" ] && [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ 发布成功！"
            echo "🎉 完成！"
            echo "- 版本号: $VERSION"
            echo "- JAR 文件: $JAR_FILE"
            if [ "$HAS_CHANGELOG" = true ]; then
              echo "- 版本日志: $CHANGELOG_FILE"
            fi
            echo "- HTTP 状态码: $HTTP_CODE"
          elif echo "$RESPONSE" | grep -qi "success\|created\|ok"; then
            echo "✅ 发布成功（从响应内容判断）！"
            echo "🎉 完成！"
            echo "- 版本号: $VERSION"
            if [ "$HAS_CHANGELOG" = true ]; then
              echo "- 版本日志: $CHANGELOG_FILE"
            fi
          else
            echo "❌ 发布失败"
            echo "HTTP 状态码: ${HTTP_CODE:-未知}"
            echo "请检查 API 响应以获取更多信息"
            exit 1
          fi



